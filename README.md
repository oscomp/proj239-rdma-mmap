# proj239-rdma-mmap

# 基于 RDMA 的远程内存映射 (mmap)

## 项目描述

在分布式的机器学习、文件存储系统、数据库等要求高性能低延迟的系统中，众多节点需要从远程节点取得数据，并在本地完成运算。因此数据的交换往往会成为瓶颈。原因在于，传统的数据传输方式的吞吐能力不足，显著增高了系统的 IO 时间，多次的缓冲区拷贝造成大量 CPU 占用。

基于 InfiniBand（IB） 网络设施与 RDMA 协议，可以实现具有超高吞吐量的数据传输方式。然而，RDMA 的复杂连接机制与原语使实现这种数据传输方式变得异常困难。目前，已经出现了 rsocket-RDMA 协议的 socket 封装，允许用户使用熟悉的 socket 接口完成数据传输功能。如果更进一步，能够实现通过 mmap 系统调用，直接将一段远程的内存映射到本地，则 RDMA 的应用将更加便捷。

目标：实现一种 mmap 机制，能够直接将一段远程主机的内存映射到本地虚拟空间，使映射的行为与本地映射别无二致，并且能够充分发挥 IB 网络和 RDMA 协议的超高吞吐能力。

最终目标：实现一个驱动或文件系统，可以在用户态提供一个文件描述符（File Descriptor，fd），对这个 fd 的访问会在驱动层转换为对应的 RDMA 操作，以实现远程 mmap。

## 所属赛道

2023 全国大学生操作系统比赛的“OS功能挑战”赛道

## 参赛要求

- 以小组为单位参赛，最多三人一个小组，且小组成员是来自同一所高校的本科生（2023年春季学期或之后本科毕业的大一~大四的学生）或研究生
- 如学生参加了多个项目，参赛学生选择一个自己参加的项目参与评奖
- 请遵循“2023全国大学生操作系统比赛”的章程和技术方案要求

## 项目导师

徐葳 `weixu(at)mail(dot)tsinghua(dot)edu(dot)cn`

## 难度

中等~高

## 特征

- 熟悉操作系统、计算机组成原理等基本知识
- 对网络协议栈、网络适配器驱动有深入理解
- 熟悉 Linux 内核下的系统调用的实现原理
- 熟悉 Linux 内核的缺页处理机制



## License

MIT license

## 预期目标

### 第一题：直接内存数据传输（RDMA）

注册一段远程主机内存为 Memory Region（向IB网卡注册的内存区域），本地主机读取远程主机的 MR 数据，验证结果的正确性。

### 第二题：具有数据传输行为的匿名内存映射

使用mmap系统调用创建一个匿名内存映射，注册这段地址为远程映射地址，访问这段地址得到的数据内容是远程主机的某段内存数据。

- 换页：使用 userfault fd 代理 os 处理换页错误，uffd 是 Linux 5.14.0 之后添加的功能，允许程序在用户态处理换页错误。在获取到页数据后，使用 ioctl 完成页的换入与缺页线程的唤醒。

### 第三题：高性能远程内存映射

优化数据传输逻辑，充分发挥RDMA协议的吞吐优势。

- 在第二题的基础上，批量换入页面，降低触发 RDMA 操作的频率，优化性能；
- 并行化处理换页错误，充分利用多核性能，提高换页的效率；
- 在 200Gbps IB 网络下，预期性能是吞吐在 100Gbps 以上。

### 第四题：可写的远程内存映射

- 在第三题的基础上，设计并实现数据同步的逻辑，允许将本地对映射内存的修改同步到远程主机内存。

### 第五题：远程内存映射的驱动实现

- 在第三题的基础上，把用户态的程序封装为驱动，允许在用户态下通过文件描述符完成远程内存映射。
